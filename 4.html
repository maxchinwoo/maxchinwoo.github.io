<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>덧셈 연습 게임</title>
<style>
  :root{
    --wrap-h: 100dvh;
    --hud-h: 44px;
    --controls-h: 36dvh;
    --canvas-h: calc(var(--wrap-h) - var(--hud-h) - var(--controls-h) - 16px);
  }
  *{ box-sizing: border-box; }
  body { margin:0; background:#000; color:#fff; font-family:sans-serif; text-align:center; }

  .wrap{
    height: var(--wrap-h);
    display: grid;
    grid-template-rows: var(--hud-h) 1fr var(--controls-h) auto;
    gap: 8px;
    padding: 8px;
  }

  #hud { font-size:18px; display:flex; align-items:center; justify-content:center; }

  .canvasBox{
    display:flex; justify-content:center; align-items:center;
    height: var(--canvas-h);
    min-height: 220px;
  }
  canvas {
    background:#111;
    border:2px solid #1e90ff; border-radius:8px;
    max-width: 100%;
    max-height: 100%;
    width: min(480px, 92vw);
    height: 100%;
  }

  /* 숫자패드 + 입력 버튼 */
  .controls { 
    display:grid;
    grid-template-columns: repeat(6, 1fr); /* 6열로 */
    grid-auto-rows: 1fr;
    gap:6px; 
    padding: 0 6px;
    align-items: stretch;
  }
  .controls button{
    width: 100%; height: 100%;
    font-size: clamp(16px, 3vw, 22px);
    border:none; border-radius:8px; background:#1e90ff; color:#fff; cursor:pointer;
    padding: 6px;
  }

  .actions{
    display:flex; justify-content:center; gap:10px; padding-bottom: 6px;
  }
  #resetBtn, #homeBtn {
    padding:8px 16px; font-size:16px; border:none; border-radius:10px; background:#1e90ff; color:#fff; cursor:pointer;
  }
</style>
</head>
<body>
<div class="wrap">
  <div id="hud">LEVEL: 1 | TIME: 60</div>

  <div class="canvasBox">
    <canvas id="game"></canvas>
  </div>

  <div class="controls" id="numPad"></div>

  <div class="actions">
    <button id="resetBtn">🔄 리셋</button>
    <button id="homeBtn">🏠 홈</button>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const hud = document.getElementById("hud");

function resizeCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width  = Math.max(300, Math.floor(rect.width * dpr));
  canvas.height = Math.max(380, Math.floor(rect.height * dpr));
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.font = "20px Arial";
}
window.addEventListener('resize', resizeCanvas);

let problems = [];
let level = 1, timeLeft = 60, score = 0;
let currentInput = "";
let isRunning = false;
let timerId = null;
let spawnTimer = null;
let fallSpeed = 1.2;

function makeProblem(){
  const a = Math.floor(Math.random()*90)+10;
  const b = Math.floor(Math.random()*9)+1;
  const maxX = Math.max(40, canvas.getBoundingClientRect().width - 40);
  const x = Math.random()* (maxX - 40) + 20;
  return { text:`${a}+${b}`, ans:a+b, x, y: 0 };
}

function setLevelSpeed(){
  if(level === 1)      fallSpeed = 1.2 * 0.2;
  else if(level === 2) fallSpeed = 1.2 * 0.3;
  else if(level === 3) fallSpeed = 1.2 * 0.4;
}

function setSpawnTimer(){
  if (spawnTimer) clearInterval(spawnTimer);
  let intervalMs = (level >= 2) ? 4000 : 5000;
  spawnTimer = setInterval(()=>{
    if(!isRunning) return;
    if (problems.length === 0) {
      problems.push(makeProblem());
    }
  }, intervalMs);
}

function resetGame(){
  level = 1; timeLeft = 60; score = 0;
  problems = []; currentInput = "";
  isRunning = true;

  setLevelSpeed();
  setSpawnTimer();

  clearInterval(timerId);
  timerId = setInterval(tick, 1000);

  resizeCanvas();
  cancelAnimationFrame(_rafId);
  _rafId = requestAnimationFrame(loop);
}
document.getElementById("resetBtn").onclick = resetGame;
document.getElementById("homeBtn").onclick = () => { location.href = "index.html"; };

function tick(){
  if(!isRunning) return;
  timeLeft--;
  if(timeLeft <= 0){
    level++;
    if(level > 3){
      alert("🎉 모든 레벨 클리어! 승리!");
      isRunning = false;
      clearInterval(timerId);
      if(spawnTimer) clearInterval(spawnTimer);
      return;
    }
    timeLeft = 60;
    setLevelSpeed();
    setSpawnTimer();
    alert(`레벨 ${level} 시작!`);
  }
}

let _rafId = 0;
function loop(){
  if(!isRunning) return;
  const rect = canvas.getBoundingClientRect();
  const W = rect.width, H = rect.height;

  ctx.clearRect(0,0,W,H);
  problems.forEach(p => p.y += fallSpeed);

  for(const p of problems){
    if(p.y >= H - 10){
      alert("💀 문제를 놓쳤습니다! 다시 시작하세요.");
      resetGame();
      return;
    }
  }

  ctx.fillStyle = "#fff";
  ctx.font = "20px Arial";
  problems.forEach(p => ctx.fillText(p.text, p.x, p.y));

  ctx.fillStyle = "#0f0";
  ctx.fillText("입력: " + currentInput, 10, Math.max(30, H - 20));

  hud.textContent = `LEVEL: ${level} | TIME: ${timeLeft}s | SCORE: ${score}`;
  _rafId = requestAnimationFrame(loop);
}

function checkAnswer(){
  if(currentInput === "") return;
  const num = parseInt(currentInput);
  for(let i=0;i<problems.length;i++){
    if(problems[i].ans === num){
      problems.splice(i,1);
      score++;
      break;
    }
  }
  currentInput = "";
}

/* 번호키 + 입력 버튼 */
const pad = document.getElementById("numPad");
(function buildPad(){
  for(let i=0;i<=9;i++){
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.onclick = () => { currentInput += i; };
    pad.appendChild(btn);
  }
  const enterBtn = document.createElement("button");
  enterBtn.textContent = "입력";
  enterBtn.onclick = checkAnswer;
  pad.appendChild(enterBtn);
})();

resizeCanvas();
resetGame();
</script>
</body>
</html>
